<!DOCTYPE html>
<html>
<head>
<title>OMR Capture</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
#wrap { position: relative; width: 300px; }
#video { width: 300px; display: block; }
#box {
  position: absolute;
  border: 3px solid red;
  top: 15%;
  left: 15%;
  width: 70%;
  height: 70%;
  pointer-events: none;
  transition: border-color 150ms ease;
}
 #box.detected { border-color: lime; }
#status { font-family: sans-serif; margin-top: 8px; color: #444; }
</style>

</head>

<body>

<h3>Place OMR inside box</h3>

<div id="wrap">
 <video id="video" autoplay playsinline></video>
  <div id="box"></div>
</div>
 <div id="status">Waiting for sheet…</div>

<br>
<button onclick="capture()">Capture</button>

<canvas id="canvas" style="display:none"></canvas>

<br><br>
<img id="result" width="300"/>

<script>
// const video = document.getElementById("video");
 const video = document.getElementById("video");
const wrap = document.getElementById("wrap");
const box = document.getElementById("box");
 const statusText = document.getElementById("status");

const OMR_RATIO = 26.5 / 21.5;
const BOX_WIDTH_RATIO = 0.7;
let isDetected = false;
let detectBusy = false;
navigator.mediaDevices.getUserMedia({
  video: { facingMode: { exact: "environment" } }
}).then(s => video.srcObject = s)
.catch(() => {
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(s => video.srcObject = s);
  });

video.addEventListener("loadedmetadata", () => {
  const displayWidth = video.clientWidth;
  const displayHeight = video.clientHeight;
  wrap.style.height = `${displayHeight}px`;

  const maxWidthByHeight = displayHeight / OMR_RATIO;
  const boxWidth = Math.min(displayWidth * BOX_WIDTH_RATIO, maxWidthByHeight);
  const boxHeight = boxWidth * OMR_RATIO;

  box.style.width = `${boxWidth}px`;
  box.style.height = `${boxHeight}px`;
  box.style.left = `${(displayWidth - boxWidth) / 2}px`;
  box.style.top = `${(displayHeight - boxHeight) / 2}px`;
  
  setInterval(updateDetectionState, 500);
});

async function updateDetectionState() {
  if (detectBusy || !video.videoWidth || !video.videoHeight) return;

  detectBusy = true;
  try {
    const c = document.getElementById("canvas");
    const ctx = c.getContext("2d");
    const MAX_W = 480;
    const scale = Math.min(1, MAX_W / video.videoWidth);
    c.width = Math.max(1, Math.floor(video.videoWidth * scale));
    c.height = Math.max(1, Math.floor(video.videoHeight * scale));

    ctx.drawImage(video, 0, 0, c.width, c.height);
    const data = c.toDataURL("image/jpeg", 0.55);

    const res = await fetch("/detect", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ img: data })
    });

    if (!res.ok) return;
    const body = await res.json();
    const detectedNow = Boolean(body.detected);

    if (detectedNow !== isDetected) {
      isDetected = detectedNow;
      box.classList.toggle("detected", isDetected);
      statusText.textContent = isDetected ? "OMR detected ✓" : "Waiting for document…";
    }
  } catch (err) {
    console.error("detect error", err);
  } finally {
    detectBusy = false;
  }
}
function capture() {
  const c = document.getElementById("canvas");

  const MAX_W = 640;
    const vw = video.videoWidth;
  const vh = video.videoHeight;
  const scale = Math.min(1, MAX_W / vw);

 c.width = Math.max(1, Math.floor(vw * scale));
  c.height = Math.max(1, Math.floor(vh * scale));


  c.getContext("2d").drawImage(video, 0, 0, c.width, c.height);

  const data = c.toDataURL("image/jpeg", 0.92);

  fetch("/process", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ img: data })
  })
    .then(r => {
      if (!r.ok) throw new Error("server error");
      return r.blob();
    })
    .then(b => {
      document.getElementById("result").src = URL.createObjectURL(b);
    })
    .catch(e => {
      alert("Capture failed. Try again.");
      console.error(e);
    });
}
</script>



</body>
</html>

