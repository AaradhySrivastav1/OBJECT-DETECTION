<!DOCTYPE html>
<html>
<head>
<title>OMR Capture</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
#wrap{position:relative;width:300px}
 #video{width:300px;display:block}
#box{
 position:absolute;
 border:3px solid lime;
 top:15%;
 left:15%;
 width:70%;
 height:70%;
 pointer-events:none;
}
</style>

</head>

<body>

<h3>Place OMR inside box</h3>

<div id="wrap">
<video id="video" autoplay playsinline></video>
<div id="box"></div>
</div>

<br>
<button onclick="capture()">Capture</button>

<canvas id="canvas" style="display:none"></canvas>

<br><br>
<img id="result" width="300"/>

<script>
// const video = document.getElementById("video");
 const video = document.getElementById("video");
const wrap = document.getElementById("wrap");
const box = document.getElementById("box");

const OMR_RATIO = 26.5 / 21.5;
const BOX_WIDTH_RATIO = 0.7;


navigator.mediaDevices.getUserMedia({
  video: { facingMode: { exact: "environment" } }
}).then(s => video.srcObject = s)
.catch(() => {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(s => video.srcObject = s);
});
 video.addEventListener("loadedmetadata", () => {
  const displayWidth = video.clientWidth;
  const displayHeight = video.clientHeight;
  wrap.style.height = `${displayHeight}px`;

  const maxWidthByHeight = displayHeight / OMR_RATIO;
  const boxWidth = Math.min(displayWidth * BOX_WIDTH_RATIO, maxWidthByHeight);
  const boxHeight = boxWidth * OMR_RATIO;

  box.style.width = `${boxWidth}px`;
  box.style.height = `${boxHeight}px`;
  box.style.left = `${(displayWidth - boxWidth) / 2}px`;
  box.style.top = `${(displayHeight - boxHeight) / 2}px`;
});


function capture(){
  const c = document.getElementById("canvas");

  const MAX_W = 640;
  let vw = video.videoWidth;
  let vh = video.videoHeight;
  let scale = Math.min(1, MAX_W / vw);

  c.width = vw * scale;
  c.height = vh * scale;

  c.getContext("2d").drawImage(video, 0, 0, c.width, c.height);

  const data = c.toDataURL("image/jpeg", 0.6);

  fetch("/process", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ img: data })
  })
    .then(r => {
      if(!r.ok) throw new Error("server error");
      return r.blob();
    })
    .then(b => {
      document.getElementById("result").src =
        URL.createObjectURL(b);
    })
    .catch(e => {
      alert("Capture failed. Try again.");
      console.error(e);
    });
}
</script>



</body>
</html>

